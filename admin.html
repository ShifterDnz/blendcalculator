<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; padding: 20px; }
        .login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #0f172a; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column;}
        input { padding: 10px; border-radius: 5px; border: 1px solid #333; background: #1e293b; color: white; margin-bottom: 10px;}
        button { padding: 10px 20px; background: #ef4444; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #1e293b; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #00205b; color: white; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .status-online { color: #4ade80; font-weight: bold; }
        .status-offline { color: #94a3b8; }
        h1 { border-bottom: 2px solid #ef4444; padding-bottom: 10px; display: inline-block;}
    </style>
</head>
<body>

    <!-- Şifre Ekranı -->
    <div id="overlay" class="login-overlay">
        <h2>Yönetici Girişi</h2>
        <input type="password" id="adminPass" placeholder="Admin Şifresi">
        <button onclick="checkPass()">Giriş</button>
        <p id="error" style="color:red; display:none">Şifre Yanlış!</p>
    </div>

    <!-- Panel İçeriği -->
    <div id="dashboard" style="display:none">
        <h1>Kullanıcı Aktiviteleri</h1>
        <button onclick="location.reload()" style="background:#334155; margin-left:20px">Yenile</button>
        
        <table>
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Son Giriş</th>
                    <th>Son İşlem/Aktiflik</th>
                    <th>Toplam İşlem</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody id="userTable">
                <tr><td colspan="5">Veriler yükleniyor...</td></tr>
            </tbody>
        </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCx2X80ULWnKEm7oOnBH_VCRZKypSgHPnk",
            authDomain: "reworkfieldcalc.firebaseapp.com",
            projectId: "reworkfieldcalc",
            storageBucket: "reworkfieldcalc.firebasestorage.app",
            messagingSenderId: "557943426846",
            appId: "1:557943426846:web:8d2a87e86741aab0d0830f",
            measurementId: "G-B96HKNTZ95"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function checkPass() {
            const p = document.getElementById('adminPass').value;
            if(p === "cinayetmemet") {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
            } else {
                document.getElementById('error').style.display = 'block';
            }
        }

        function loadData() {
            db.collection('users').orderBy('lastActive', 'desc').get().then(snap => {
                const tbody = document.getElementById('userTable');
                tbody.innerHTML = "";
                
                snap.forEach(doc => {
                    const data = doc.data();
                    // Tarih formatlama
                    const lastActive = data.lastActive ? data.lastActive.toDate().toLocaleString('tr-TR') : '-';
                    const lastLogin = data.lastLogin ? data.lastLogin.toDate().toLocaleString('tr-TR') : '-';
                    
                    // Online durumu (Son 5 dk içinde aktifse online say)
                    const now = new Date();
                    const diff = data.lastActive ? (now - data.lastActive.toDate()) / 1000 / 60 : 999;
                    const status = diff < 5 ? '<span class="status-online">Çevrimiçi</span>' : '<span class="status-offline">Çevrimdışı</span>';

                    const row = `
                        <tr>
                            <td>${data.email}</td>
                            <td>${lastLogin}</td>
                            <td>${lastActive}</td>
                            <td style="font-weight:bold; text-align:center">${data.totalActions || 0}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }
    </script>
</body>
</html>