<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Calculator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ef4444">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/723/723955.png">
    <style>
        /* Önceki stil kodları korundu, sadeleştirildi */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        :root { --bg: #0f172a; --panel: rgba(30,41,59,0.8); --acc: #ef4444; --text: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 999; display: flex; justify-content: center; align-items: center; color: #94a3b8; flex-direction: column;}
        .sidebar { width: 360px; background: var(--panel); backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.1); padding: 20px; display: flex; flex-direction: column; z-index: 10;}
        .canvas-area { flex: 1; position: relative; cursor: crosshair; }
        canvas { position: absolute; top:0; left:0; }
        .header { font-weight: 800; font-size: 1.2rem; margin-bottom: 20px; } .header span { color: var(--acc); }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .mode-switch { display: flex; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 8px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 8px; background: transparent; color: #94a3b8; }
        .mode-btn.active { background: #0039a6; color: white; }
        .mode-btn.active-ab { background: #00205b; color: white; }
        input { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px; width: 100%; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box;}
        .res-card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; display: inline-block; margin-top: 10px;}
        .safe { background: rgba(74,222,128,0.2); color: #4ade80; } .unsafe { background: rgba(248,113,113,0.2); color: #f87171; }
        #logout { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: #ccc; padding: 5px 10px; z-index: 100; }
        .points-list { flex: 1; overflow-y: auto; }
        .point-item { background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; border-left: 3px solid var(--acc); }
        .connector { font-size: 0.8rem; color: #94a3b8; margin-left: 10px; padding-left: 10px; border-left: 1px dashed #666; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;}
        .connector input { width: 60px; padding: 2px; margin: 0;}
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="loading"><span>Yetki Kontrolü...</span></div>
    <button id="logout" onclick="logout()">ÇIKIŞ</button>

    <div class="sidebar">
        <div class="header">FIELD<span>CALC</span></div>
        <div class="mode-switch">
            <button class="mode-btn active" id="btnBoeing" onclick="setMode('boeing')">BOEING</button>
            <button class="mode-btn" id="btnAirbus" onclick="setMode('airbus')">AIRBUS</button>
        </div>
        <input type="number" id="limitInput" value="5.00" step="0.01" oninput="redraw()">
        <button style="background:rgba(239,68,68,0.2); color:#ef4444; padding:8px; width:100%" onclick="resetShape()">SIFIRLA</button>
        
        <div class="points-list" id="pointsList"></div>
        
        <div class="res-card">
            <span id="areaText" style="font-size: 2rem; font-weight: 800;">0.00</span> <span id="unitLabel">in²</span>
            <br><span id="statusBadge" class="badge safe" style="display:none">UYGUN</span>
        </div>
    </div>

    <div class="canvas-area" id="canvasWrapper">
        <canvas id="mainCanvas"></canvas>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCx2X80ULWnKEm7oOnBH_VCRZKypSgHPnk",
            authDomain: "reworkfieldcalc.firebaseapp.com",
            projectId: "reworkfieldcalc",
            storageBucket: "reworkfieldcalc.firebasestorage.app",
            messagingSenderId: "557943426846",
            appId: "1:557943426846:web:8d2a87e86741aab0d0830f",
            measurementId: "G-B96HKNTZ95"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(u => {
            const l = document.getElementById('loading');
            if(u && u.email.endsWith('@thy.com')) {
                currentUser = u;
                l.style.display = 'none';
                startHeartbeat(); // Sitede kalma süresini takip et
            } else {
                window.location.href = "login.html";
            }
        });

        function logout() { auth.signOut().then(() => window.location.href = "login.html"); }

        // İstatistik Kaydetme (App.js'den çağrılacak)
        window.logAction = function() {
            if(currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    totalActions: firebase.firestore.FieldValue.increment(1),
                    lastActive: new Date()
                });
            }
        };

        // Her 1 dakikada bir "Son Görülme" zamanını güncelle
        function startHeartbeat() {
            setInterval(() => {
                if(currentUser) {
                    db.collection('users').doc(currentUser.uid).update({ lastActive: new Date() });
                }
            }, 60000);
        }

        document.onkeydown = function(e) { if(e.keyCode == 123) return false; } // F12 Engelleme
    </script>
    <script src="app.js"></script>
</body>
</html>
